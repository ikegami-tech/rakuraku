<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>部屋ピン</title>
<link rel="icon" href="favicon.ico">
<link rel="stylesheet" href="style.css">
</head>
<body>

<div id="loading">読み込み中...</div>

<div id="login-screen">
  <div class="login-box">
    <h2>ログイン</h2>
    <input type="text" id="loginId" placeholder="ユーザーID">
    <input type="password" id="loginPass" placeholder="パスワード">
    <button type="button" class="btn-primary" onclick="tryLogin()">ログイン</button>
  </div>
</div>

<div id="app-screen">
  <header>
    <div class="header-left-group">
      <div id="header-title" onclick="switchTab('map-view')" style="cursor: pointer;">部屋予約</div>
      <button type="button" class="btn-header-refresh" onclick="manualRefresh()">
        <span>&#8635;</span> 更新
      </button>
      <span id="last-update-time" class="last-update-text"></span>
    </div>

    <div class="user-info">
      <button id="btn-header-back" class="btn-header-back" onclick="switchTab('map-view')" style="display: none;">
        ↩ 戻る
      </button>

      <div class="settings-container">
        <span class="settings-icon" onclick="toggleSettingsMenu()">&#9881;</span>
        <div id="settings-dropdown" class="settings-dropdown-content">
          <div class="settings-user-display">
              👤 <span id="display-user-name"></span> さん
          </div>
          <div class="settings-item" onclick="openPasswordModal()">
            <span>&#128274;</span> PW変更 
          </div>
          <div class="settings-item" onclick="openHistoryFromMenu()">
            <span>📅</span> 履歴
          </div>
          <div class="settings-item" onclick="openContactModal()">
            <span>&#9993;</span> お問い合わせ 
          </div>
          <div class="settings-item logout-item" onclick="logout()">
            <span>&#10162;</span> ログアウト
          </div>
        </div>
      </div>
    </div>
  </header>

  <div id="view-map-view" class="view-container active">
    <div class="map-wrapper">
      
      <div class="floor-selector">
          <button class="floor-tab active" onclick="switchFloor(7)" id="tab-7f">7階</button>
          <button class="floor-tab" onclick="switchFloor(6)" id="tab-6f">6階</button>
      </div>
<div id="dual-map-container">
        <div id="area-7f" class="floor-map-unit active">
            <div class="map-inner-wrapper">
                <img id="map-img-7" src="" alt="7階マップ" class="map-image">
                <div id="overlay-container-7" class="overlay-layer"></div>
            </div>
        </div>

        <div id="area-6f" class="floor-map-unit">
            <div class="map-inner-wrapper">
                <img id="map-img-6" src="" alt="6階マップ" class="map-image">
                <div id="overlay-container-6" class="overlay-layer"></div>
            </div>
        </div>
      </div>
      
      <div id="map-timeline-section" class="map-timeline-hidden">
        
      <div class="date-controller" style="display: flex; justify-content: center; align-items: center; gap: 10px;">
  <button type="button" onclick="changeDate(-1, 'map-date')" 
          style="width: 50px !important; min-width: 50px !important; flex: 0 0 50px !important; height: 38px !important; padding: 0 !important; margin: 0 !important;">
    &lt;
  </button>

  <div style="display: flex; align-items: center; justify-content: center; gap: 5px;">
      <input type="date" id="map-date" onchange="renderVerticalTimeline('map'); updateDayDisplay('map-date');" 
             style="width: 150px !important; height: 38px !important; margin-bottom: 0 !important; font-size: 16px;">
      <span id="map-date-week" style="font-weight:bold; font-size:1rem; min-width: 30px;"></span>
  </div>

  <button type="button" onclick="changeDate(1, 'map-date')" 
          style="width: 50px !important; min-width: 50px !important; flex: 0 0 50px !important; height: 38px !important; padding: 0 !important; margin: 0 !important;">
    &gt;
  </button>
</div>
        
        <div class="calendar-scroll-area">
            <div class="time-axis-col" id="time-axis-map"><div class="time-axis-header"></div></div>
            <div class="rooms-container" id="rooms-container-map"></div>
        </div>
      </div>

    </div>
    
    <button class="fab-avail-btn" onclick="openAvailabilityModal()">
      <span>空室</span>
      <span>確認</span>
    </button>
  </div>
  
  <div id="view-logs" class="view-container">
    <div class="log-wrapper">
      <div class="log-header-area">
          <h3>操作履歴 (最大1000件)</h3>
          <div class="log-search-box">
              <input type="text" id="log-search-input" placeholder="履歴を検索..." oninput="searchLogs()">
          </div>
      </div>
      <table class="log-table">
        <thead><tr><th>日時</th><th>操作者</th><th>操作</th><th>詳細</th></tr></thead>
        <tbody id="log-tbody"></tbody>
      </table>
      <div id="log-pagination" class="pagination-container"></div>
    </div>
  </div>
</div>
  
<div id="detailModal" class="modal">
  <div class="modal-content modal-sm">
    <div class="detail-header-wrapper">
      <h3 class="modal-header-line">予約詳細</h3>
      <div id="detail-meta-info" class="detail-meta-info"></div>
    </div>
    <table class="detail-table">
      <tr><th>日時</th><td id="detail-time" class="text-bold text-lg"></td></tr>
      <tr><th>部屋</th><td id="detail-room"></td></tr>
      <tr><th>用件</th><td id="detail-title"></td></tr>
      <tr><th>参加者</th><td id="detail-members"></td></tr>
      <tr>
        <th>備考</th>
        <td>
          <div id="detail-note" class="note-scroll-area text-muted"></div>
        </td>
      </tr>
    </table>

    <div class="modal-footer">
      <button type="button" onclick="closeDetailModal()" class="btn-secondary btn-equal">閉じる</button>
      <button type="button" id="btn-go-edit" class="btn-primary btn-equal">編集する</button>
    </div>
  </div>
</div>

<div id="bookingModal" class="modal">
  <div class="modal-content">
    <div class="modal-top-bar">
        <h3 id="modal-title">新規予約</h3>
        <span onclick="closeModal()" class="close-icon">&times;</span>
    </div>
    <input type="hidden" id="edit-res-id">
    
    <div class="form-group">
        <label>部屋</label>
        <select id="input-room"></select>
    </div>

    <div class="form-row align-end mb-15">
      <div class="flex-1-2">
        <label for="input-date">日付</label>
        <input type="date" id="input-date">
      </div>

      <div class="flex-1">
        <label for="input-start">開始</label>
        <div class="time-picker-wrapper">
          <input type="tel" id="input-start" placeholder="09:00" autocomplete="off"
                 onclick="selectTimePart(this)" 
                 onkeyup="handleTimeArrowKeys(event, this)"
                 onblur="formatTimeInput(this)">
          <div class="time-picker-arrow">▼</div>
          </div>
      </div>

      <div class="time-range-sep">～</div>

      <div class="flex-1">
        <label for="input-end">終了</label>
        <div class="time-picker-wrapper">
          <input type="tel" id="input-end" placeholder="10:00" autocomplete="off"
                 onclick="selectTimePart(this)" 
                 onkeyup="handleTimeArrowKeys(event, this)"
                 onblur="formatTimeInput(this)">
          <div class="time-picker-arrow">▼</div>
        </div>
      </div>
    </div>

    <label>用件 (タイトル)</label>
    <input type="text" id="input-title" placeholder="定例会議など">
    
    <label>参加者設定</label>
    <div class="group-container" id="group-buttons-area"></div>
    
    <div class="shuttle-container">
        <div class="shuttle-box">
            <div class="shuttle-header">候補者一覧</div>
            <div class="shuttle-search">
                <input type="text" placeholder="名前検索..." id="shuttle-search-input" oninput="renderShuttleLists(this.value)">
            </div>
            <div class="shuttle-list" id="list-candidates"></div>
        </div>
        <div class="shuttle-box bg-selected">
            <div class="shuttle-header bg-header-selected">参加予定者</div>
            <div class="shuttle-list" id="list-selected"></div>
        </div>
    </div>
    
    <label>備考</label>
    <textarea id="input-note" rows="2" placeholder="備品要望など"></textarea>

    <div class="modal-footer">
      <button type="button" id="btn-back-avail" class="btn-secondary" onclick="backToAvailability()" style="display:none; margin-right:auto;">← 戻る</button>
      <button type="button" id="btn-modal-cancel" onclick="closeModal()" class="btn-secondary">キャンセル</button>
      <button type="button" id="btn-save" class="btn-primary" onclick="saveBooking()">保存</button>
      <button type="button" id="btn-delete" class="btn-danger" onclick="deleteBooking()" style="display:none;">削除</button>
    </div>

  </div>
</div>

<div id="groupCreateModal" class="modal">
  <div class="modal-content modal-md">
    <h3 class="mt-0" id="group-modal-title">グループ作成</h3>
    <input type="hidden" id="edit-group-id">
    
    <label>グループ名</label>
    <input type="text" id="new-group-name" placeholder="例: プロジェクトAチーム">
    
    <label>メンバー選択</label>
    <div class="shuttle-container">
        <div class="shuttle-box">
            <div class="shuttle-header">候補者</div>
            <div class="shuttle-search">
                <input type="text" placeholder="検索..." id="group-shuttle-search" oninput="renderGroupCreateShuttle()">
            </div>
            <div class="shuttle-list" id="group-create-candidates"></div>
        </div>
        <div class="shuttle-box bg-selected">
            <div class="shuttle-header bg-header-selected">選択中</div>
            <div class="shuttle-list" id="group-create-selected"></div>
        </div>
    </div>

    <div class="modal-footer justify-end">
      <button type="button" onclick="closeGroupModal()" class="btn-secondary">キャンセル</button>
      <button type="button" class="btn-primary" onclick="saveNewGroup()">保存</button>
    </div>
  </div>
</div>

<div id="availabilityModal" class="modal">
  <div class="modal-content modal-md">
    <div class="modal-top-bar">
      <h3>空き状況を確認</h3>
      <span class="close-icon" onclick="closeAvailabilityModal()">&times;</span>
    </div>

    <div style="background:#f9f9f9; padding:15px; border-radius:8px; margin-bottom:15px;">
      <div class="avail-search-row">
        
        <div class="avail-input-group">
          <label>日付</label>
          <input type="date" id="avail-date">
        </div>

        <div class="avail-time-row">
            <div class="avail-input-group">
              <label>開始</label>
              <div class="time-picker-wrapper">
                <input type="tel" id="avail-start" placeholder="09:00" autocomplete="off"
                       onclick="selectTimePart(this)" 
                       onkeyup="handleTimeArrowKeys(event, this)"
                       onblur="formatTimeInput(this)">
                <div class="time-picker-arrow">▼</div>
              </div>
            </div>

            <div class="time-range-sep">～</div>

            <div class="avail-input-group">
              <label>終了</label>
              <div class="time-picker-wrapper">
                <input type="tel" id="avail-end" placeholder="10:00" autocomplete="off"
                       onclick="selectTimePart(this)" 
                       onkeyup="handleTimeArrowKeys(event, this)"
                       onblur="formatTimeInput(this)">
                <div class="time-picker-arrow">▼</div>
              </div>
            </div>
        </div>
        <button class="btn-primary btn-search-avail" onclick="execAvailabilitySearch()">検索</button>
      </div>
    </div>

    <div id="avail-result-container" style="overflow-y:auto; flex:1; border-top:1px solid #eee;"></div>
    
    <div class="modal-footer">
      <button class="btn-secondary" onclick="closeAvailabilityModal()">閉じる</button>
    </div>
  </div>
</div>

<div id="passwordModal" class="modal">
  <div class="modal-content modal-sm">
    <div class="modal-top-bar">
      <h3>パスワード変更</h3>
      <span class="close-icon" onclick="closePasswordModal()">&times;</span>
    </div>

    <label>現在のパスワード</label>
    <input type="password" id="old-pass" placeholder="現在のパスワード">

    <label>新しいパスワード</label>
    <input type="password" id="new-pass" placeholder="新しいパスワード">

    <label>新しいパスワード(確認)</label>
    <input type="password" id="new-pass-confirm" placeholder="もう一度入力">

    <div class="modal-footer">
      <button type="button" class="btn-secondary" onclick="closePasswordModal()">キャンセル</button>
      <button type="button" class="btn-primary" onclick="savePassword()">変更する</button>
    </div>
  </div>
</div>

<div id="contactModal" class="modal">
  <div class="modal-content modal-sm">
    <div class="modal-top-bar">
      <h3>お問い合わせ</h3>
      <span class="close-icon" onclick="closeContactModal()">&times;</span>
    </div>
    
    <p style="font-size:0.9rem; color:#666; margin-bottom:10px;">
      システムの不具合や改善要望など、お気づきの点をお知らせください。
    </p>

    <label>内容</label>
    <textarea id="contact-message" rows="5" placeholder="例: ○○の機能が使いにくい、××という機能が欲しい、など" style="width:100%; min-height:100px; padding:10px;"></textarea>

    <div class="modal-footer">
      <button type="button" class="btn-secondary" onclick="closeContactModal()">キャンセル</button>
      <button type="button" class="btn-primary" onclick="sendContactFeedback()">送信する</button>
    </div>
  </div>
</div>
  
<script src="script.js"></script>
</body>
</html>
